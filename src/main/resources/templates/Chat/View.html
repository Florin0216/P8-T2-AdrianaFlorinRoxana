<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{Shared/_Layout.html}">
<head>
    <title>Chat</title>
</head>
<body>
<div layout:fragment="body">
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Chat Room ID: <span th:text="${chatId}"></span></h5>
                    </div>
                    <div class="card-body">
                        <div class="overflow-auto mb-3 chat-container border-bottom border-dark-subtle">
                            <div class="mb-2 " th:each="message : ${pastMessages}"
                                 th:classappend="${message.sender.username == username ? 'd-flex justify-content-end' : 'd-flex justify-content-start'}">
                                <div class="p-2 rounded"
                                     th:classappend="${message.sender.username == username ? 'bg-primary text-white' : 'bg-light'}">
                                    <div class="fw-bold" th:if="${message.sender.username != username}"
                                         th:text="${message.sender.username}"></div>
                                    <div th:text="${message.text}"></div>
                                </div>
                            </div>
                            <div id="messages">
                            </div>
                        </div>
                        <div class="input-group bg-dark-subtle">
                            <input type="text" id="messageInput" class="form-control" placeholder="Type your message..."
                                   aria-label="Message Input">
                            <button class="btn btn-primary" type="button" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        const chatId = /*[[${chatId}]]*/ 'default';
        const username = /*[[${username}]]*/ 'user';
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const chatContainer = document.getElementById('chat-container');
        let stompClient = null;

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                stompClient.subscribe('/topic/messages', function (message) {
                    showMessage(JSON.parse(message.body));
                });
            });
        }

        function sendMessage() {
            let messageContent = messageInput.value;
            stompClient.send("/app/chat/sendMessage/" + chatId, {}, JSON.stringify({'text': messageContent}));
            messageInput.value = '';
        }


        function showMessage(message) {
            const messageContainer = document.createElement('div');
            const contentElement = document.createElement('div');
            const boxElement = document.createElement('div');

            const isOwnMessage = message.sender.username === username;

            if (!isOwnMessage) {
                const senderElement = document.createElement('div');
                senderElement.classList.add('fw-bold');
                senderElement.appendChild(document.createTextNode(message.sender.username));
                boxElement.appendChild(senderElement);
            }

            contentElement.appendChild(document.createTextNode(message.text));
            boxElement.appendChild(contentElement);

            if (isOwnMessage) {
                messageContainer.classList.add('d-flex', 'justify-content-end', 'mb-2');
                boxElement.classList.add('rounded', 'p-2', 'bg-primary', 'text-white');
            } else {
                messageContainer.classList.add('d-flex', 'justify-content-start', 'mb-2');
                boxElement.classList.add('rounded', 'p-2', 'bg-light');
            }

            messageContainer.appendChild(boxElement);
            messagesDiv.appendChild(messageContainer);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        connect();
        /*]]>*/
    </script>
</div>
</body>
</html>